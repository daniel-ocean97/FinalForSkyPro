<!-- restaurant/templates/restaurant/reservation.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Бронирование - {{ restaurant.name }}{% endblock %}

{% block extra_css %}
<style>
    .time-slot {
        transition: all 0.3s ease;
    }
    
    .time-slot:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .table-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .table-card:hover, .table-card.selected {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border: 2px solid var(--accent-color);
    }
    
    .table-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .confirmation-step {
        display: none;
    }
    
    .confirmation-step.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" 
         style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                url('{% if restaurant.cover_image %}{{ restaurant.cover_image.url }}{% else %}https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80{% endif %}');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-4">Бронирование столика</h1>
        <p class="lead mb-4">Забронируйте столик онлайн всего за несколько кликов</p>
    </div>
</section>

<!-- Процесс бронирования -->
<div class="container mb-5">
    <!-- Индикатор прогресса -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-center flex-fill">
                            <span class="badge bg-primary rounded-circle p-2 mb-2">1</span>
                            <p class="mb-0 small">Выбор даты и времени</p>
                        </div>
                        <div class="flex-fill">
                            <hr class="progress-divider">
                        </div>
                        <div class="text-center flex-fill">
                            <span class="badge bg-secondary rounded-circle p-2 mb-2">2</span>
                            <p class="mb-0 small">Выбор столика</p>
                        </div>
                        <div class="flex-fill">
                            <hr class="progress-divider">
                        </div>
                        <div class="text-center flex-fill">
                            <span class="badge bg-secondary rounded-circle p-2 mb-2">3</span>
                            <p class="mb-0 small">Ваши данные</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Шаг 1: Выбор даты и времени -->
    <div class="confirmation-step active" id="step1">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Выберите дату и время</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="reservationDate" class="form-label">Дата *</label>
                                <input type="date" class="form-control" id="reservationDate" min="{{ today }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="guestsCount" class="form-label">Количество гостей *</label>
                                <select class="form-select" id="guestsCount">
                                    <option value="1">1 человек</option>
                                    <option value="2">2 человека</option>
                                    <option value="3">3 человека</option>
                                    <option value="4" selected>4 человека</option>
                                    <option value="5">5 человек</option>
                                    <option value="6">6 человек</option>
                                    <option value="7">7+ человек</option>
                                </select>
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3">Доступное время</h5>
                        <div class="row" id="timeSlots">
                            {% for hour in available_hours %}
                            <div class="col-4 col-sm-3 mb-2">
                                <div class="card time-slot text-center p-2 {% if not hour.available %}bg-secondary text-white{% endif %}" 
                                     data-time="{{ hour.time }}">
                                    {{ hour.time }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary" onclick="showStep(2)">Продолжить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Шаг 2: Выбор столика -->
    <div class="confirmation-step" id="step2">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Выберите столик</h3>
                        <p class="text-muted">Доступные столики на <span id="selectedDateTime">17 июня, 19:00</span> для <span id="selectedGuests">4 гостей</span></p>
                        
                        <div class="row mt-4">
                            {% for table in tables %}
                            <div class="col-md-3 mb-4">
                                <div class="card table-card text-center p-3 {% if not table.available %}disabled{% endif %}" 
                                     data-table-id="{{ table.id }}">
                                    <h5>Столик {{ table.number }}</h5>
                                    <p class="text-muted">{{ table.description }}</p>
                                    <div class="mt-2">
                                        <span class="badge {% if table.available %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if table.available %}Доступен{% else %}Занят{% endif %}
                                        </span>
                                    </div>
                                    <p class="mt-2 mb-0">до {{ table.capacity }} человек</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" onclick="showStep(1)">Назад</button>
                            <button class="btn btn-primary" onclick="showStep(3)">Продолжить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Шаг 3: Ваши данные -->
    <div class="confirmation-step" id="step3">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4">Ваши данные</h3>
                        
                        <form id="reservationForm">
                            {% csrf_token %}
                            <input type="hidden" id="selectedDate" name="date">
                            <input type="hidden" id="selectedTime" name="time">
                            <input type="hidden" id="selectedTable" name="table">
                            <input type="hidden" id="selectedGuestsCount" name="guests_count">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="clientName" class="form-label">Имя *</label>
                                    <input type="text" class="form-control" id="clientName" name="client_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="clientPhone" class="form-label">Телефон *</label>
                                    <input type="tel" class="form-control" id="clientPhone" name="client_phone" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="clientEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="clientEmail" name="client_email">
                            </div>
                            
                            <div class="mb-3">
                                <label for="specialRequests" class="form-label">Особые пожелания</label>
                                <textarea class="form-control" id="specialRequests" name="special_requests" rows="3" placeholder="Аллергии, праздник, особые требования..."></textarea>
                            </div>
                            
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="agreement" required>
                                <label class="form-check-label" for="agreement">
                                    Я соглашаюсь с правилами бронирования и обработкой персональных данных
                                </label>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" onclick="showStep(2)">Назад</button>
                                <button type="submit" class="btn btn-primary">Забронировать</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Бронирование подтверждено!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <h3 class="my-3">Бронирование подтверждено!</h3>
                    <p class="text-muted">Мы отправили детали бронирования на вашу почту</p>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="text-center">Детали бронирования</h5>
                        <div class="info-item">
                            <i class="bi bi-calendar-event"></i>
                            <span id="modalDate"></span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-people"></i>
                            <span id="modalGuests"></span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-geo-alt"></i>
                            <span id="modalTable"></span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-person"></i>
                            <span id="modalName"></span>
                        </div>
                        <div class="info-item">
                            <i class="bi bi-telephone"></i>
                            <span id="modalPhone"></span>
                        </div>
                        <div class="info-item" id="modalEmailContainer" style="display: none;">
                            <i class="bi bi-envelope"></i>
                            <span id="modalEmail"></span>
                        </div>
                        <div class="info-item" id="modalRequestsContainer" style="display: none;">
                            <i class="bi bi-chat-text"></i>
                            <span id="modalRequests"></span>
                        </div>
                    </div>
                </div>

                <p class="text-muted small">
                    Пожалуйста, приходите за 10-15 минут до назначенного времени.<br>
                    При отмене бронирования просим сообщить заранее.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="{% url 'restaurant:restaurant_detail' %}" class="btn btn-primary">Вернуться на главную</a>
            </div>
        </div>
    </div>
</div>

<!-- Информация о бронировании -->
<div class="container mb-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title mb-4">Правила бронирования</h3>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex">
                                <i class="bi bi-clock-history text-primary me-3 fs-4"></i>
                                <div>
                                    <h5>Время прибытия</h5>
                                    <p class="text-muted">Пожалуйста, приходите вовремя. Мы храним столик в течение 15 минут после назначенного времени.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex">
                                <i class="bi bi-x-circle text-primary me-3 fs-4"></i>
                                <div>
                                    <h5>Отмена брони</h5>
                                    <p class="text-muted">Вы можете отменить бронь бесплатно за 2 часа до визита.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex">
                                <i class="bi bi-credit-card text-primary me-3 fs-4"></i>
                                <div>
                                    <h5>Предоплата</h5>
                                    <p class="text-muted">Для компаний от 8 человек требуется предоплата 20% от суммы счета.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Текущая дата для ограничения выбора
    document.getElementById('reservationDate').min = new Date().toISOString().split('T')[0];
    
    // Функция переключения между шагами
    function showStep(stepNumber) {
        document.querySelectorAll('.confirmation-step').forEach(step => {
            step.classList.remove('active');
        });
        document.getElementById('step' + stepNumber).classList.add('active');
        
        // Обновление индикатора прогресса
        document.querySelectorAll('.progress-divider').forEach((divider, index) => {
            if (index < stepNumber - 1) {
                divider.classList.add('bg-primary');
            } else {
                divider.classList.remove('bg-primary');
            }
        });
        
        document.querySelectorAll('.badge.rounded-circle').forEach((badge, index) => {
            if (index < stepNumber) {
                badge.classList.add('bg-primary');
                badge.classList.remove('bg-secondary');
            } else {
                badge.classList.remove('bg-primary');
                badge.classList.add('bg-secondary');
            }
        });
    }
    
    // Выбор времени
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.addEventListener('click', function() {
            if (!this.classList.contains('bg-secondary')) {
                document.querySelectorAll('.time-slot').forEach(s => {
                    s.classList.remove('bg-primary', 'text-white');
                });
                this.classList.add('bg-primary', 'text-white');
                
                // Сохраняем выбранное время
                document.getElementById('selectedTime').value = this.dataset.time;
            }
        });
    });
    
    // Выбор столика
    document.querySelectorAll('.table-card:not(.disabled)').forEach(table => {
        table.addEventListener('click', function() {
            document.querySelectorAll('.table-card').forEach(t => {
                t.classList.remove('selected');
            });
            this.classList.add('selected');
            
            // Сохраняем выбранный столик
            document.getElementById('selectedTable').value = this.dataset.tableId;
        });
    });
    
    // Обработка формы бронирования
    document.getElementById('reservationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Собираем данные
        const formData = new FormData(this);
        formData.append('date', document.getElementById('reservationDate').value);
        formData.append('guests_count', document.getElementById('guestsCount').value);
        
        // Отправляем AJAX запрос
        fetch('{% url "restaurant:reservation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Заполняем модальное окно данными
                document.getElementById('modalDate').textContent = data.reservation.date + ' ' + data.reservation.time;
                document.getElementById('modalGuests').textContent = data.reservation.guests_count + ' гостя';
                document.getElementById('modalTable').textContent = 'Столик ' + data.reservation.table_number + ' (' + data.reservation.table_description + ')';
                document.getElementById('modalName').textContent = data.reservation.client_name;
                document.getElementById('modalPhone').textContent = data.reservation.client_phone;
                
                if (data.reservation.client_email) {
                    document.getElementById('modalEmail').textContent = data.reservation.client_email;
                    document.getElementById('modalEmailContainer').style.display = 'flex';
                }
                
                if (data.reservation.special_requests) {
                    document.getElementById('modalRequests').textContent = data.reservation.special_requests;
                    document.getElementById('modalRequestsContainer').style.display = 'flex';
                }
                
                // Показываем модальное окно
                var reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
                reservationModal.show();
            } else {
                alert('Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при бронировании. Пожалуйста, попробуйте еще раз.');
        });
    });
    
    // Обновляем скрытые поля при изменении данных
    document.getElementById('reservationDate').addEventListener('change', function() {
        document.getElementById('selectedDate').value = this.value;
    });
    
    document.getElementById('guestsCount').addEventListener('change', function() {
        document.getElementById('selectedGuestsCount').value = this.value;
    });
</script>
{% endblock %}